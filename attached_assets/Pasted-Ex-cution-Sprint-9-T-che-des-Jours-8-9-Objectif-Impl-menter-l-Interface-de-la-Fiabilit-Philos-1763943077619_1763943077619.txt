Ex√©cution : Sprint 9 - T√¢che des Jours 8-9
Objectif : Impl√©menter l'Interface de la Fiabilit√©
Philosophie : "La transparence n'est pas une option, c'est une fonctionnalit√©." Nous allons donner √† l'utilisateur une vue claire et intuitive sur le processus de v√©rification des faits, transformant la confiance d'un sentiment en une certitude visuelle.
Sous-√âtape 3.1 : Mise √† Jour du SynthesizerAgent et du CognitiveProcessor
Le synth√©tiseur doit maintenant utiliser le rapport de v√©rification riche et le processeur doit transmettre les sources √† l'UI.
Fichier : src/agents/personas/synthesizer-prompt-v3.ts (Nouveau)
TypeScript

export const SYNTHESIZER_PROMPT_V3 = (draft: string, critique: string, verificationReport: VerificationResult[]): string => {
    const verificationSummary = verificationReport.length > 0 ? `
# RAPPORT DE V√âRIFICATION FACTUELLE
Voici le r√©sultat de la v√©rification des faits du brouillon initial. Tu DOIS en tenir compte.
${verificationReport.map(v => `- Affirmation : "${v.claim}" -> Statut : ${v.status} (Confiance: ${(v.confidenceScore * 100).toFixed(0)}%)`).join('\n')}

# R√àGLES DE SYNTH√àSE BAS√âES SUR LES FAITS
- Si un fait est 'VERIFIED' avec une confiance > 80%, tu peux l'affirmer avec assurance.
- Si un fait est 'VERIFIED' avec une confiance < 80%, tu dois le nuancer (ex: "il semble que...", "selon une source...").
- Si un fait est 'UNKNOWN', tu dois l'omettre ou le pr√©senter comme une sp√©culation non v√©rifi√©e.
- Si un fait est 'CONTRADICTED' ou 'AMBIGUOUS', tu DOIS mentionner l'incertitude ou le conflit des sources. C'est un point crucial de ta cr√©dibilit√©.
`.trim() : '# RAPPORT DE V√âRIFICATION FACTUELLE\nAucune v√©rification de faits n\'a √©t√© effectu√©e.';

    return `
# R√îLE : Synth√©tiseur Final
# MISSION : Am√©liorer le BROUILLON en int√©grant la CRITIQUE et en respectant imp√©rativement le RAPPORT DE V√âRIFICATION FACTUELLE pour produire une r√©ponse finale, nuanc√©e et factuellement juste.

# BROUILLON INITIAL
${draft}

# CRITIQUE CONSTRUCTIVE
${critique}

${verificationSummary}

# TA R√âPONSE FINALE AM√âLIOR√âE :
`;
};

Fichier : src/core/oie/CognitiveProcessor.ts (extrait)
TypeScript

// ... dans la m√©thode run, apr√®s l'ex√©cution du plan

const { finalResponse, journal } = await this.taskExecutor.execute(plan, context);

// Extraire les sources uniques du journal pour les attacher au message
const verificationStep = journal.getStepById('step3_factcheck');
const sources = new Map<string, any>();
if (verificationStep && verificationStep.result) {
    const verificationResults: VerificationResult[] = verificationStep.result;
    for (const result of verificationResults) {
        if (result.evidence && !sources.has(result.evidence.sourceNodeId)) {
            sources.set(result.evidence.sourceNodeId, {
                id: result.evidence.sourceNodeId,
                title: result.evidence.content.substring(0, 70) + '...' // Titre simplifi√©
            });
        }
    }
}

// Envoyer la r√©ponse finale, le journal, ET les sources √† l'UI
this.runtime.sendToUI('final-response', {
    queryId: this.task.id,
    content: finalResponse,
    journal: journal.serialize(),
    sources: Array.from(sources.values()) // Convertir la map en tableau
});

    Commentaire : Le SynthesizerAgent a maintenant des instructions tr√®s claires sur comment g√©rer chaque statut de v√©rification. Le CognitiveProcessor agit comme un filtre, extrayant les sources uniques utilis√©es pendant la v√©rification pour les fournir proprement √† l'interface utilisateur.

Sous-√âtape 3.2 : Mise √† Jour de l'Interface (JournalCognitif et ChatMessage)
Nous cr√©ons les composants React pour afficher ces nouvelles informations.
Fichier : src/ui/components/JournalCognitif.tsx (mise √† jour)
TypeScript

// ... imports
import { VerificationResult } from '../../types/verification';

// Nouveau sous-composant pour afficher le r√©sultat d'une v√©rification
const VerificationResultItem: React.FC<{ result: VerificationResult }> = ({ result }) => {
    const getStatusIcon = () => {
        switch (result.status) {
            case 'VERIFIED': return '‚úÖ';
            case 'CONTRADICTED': return '‚ùå';
            case 'AMBIGUOUS': return 'üü°';
            case 'UNKNOWN': return '‚ö†Ô∏è';
            default: return '‚ùì';
        }
    };

    return (
        <div className="verification-item">
            <span>{getStatusIcon()} {result.claim}</span>
            <small>(Confiance: {(result.confidenceScore * 100).toFixed(0)}%)</small>
            {result.evidence && <p className="evidence">Source: "{result.evidence.content.substring(0, 100)}..."</p>}
        </div>
    );
};

// ... dans le composant JournalStep
// Si l'√©tape est la v√©rification des faits, on utilise notre nouveau composant
if (step.id === 'step3_factcheck' && Array.isArray(step.result)) {
    return (
        <div className="journal-step">
            <h4>{step.title} ({step.duration.toFixed(0)}ms)</h4>
            <div className="verification-list">
                {(step.result as VerificationResult[]).map((res, i) => (
                    <VerificationResultItem key={i} result={res} />
                ))}
            </div>
        </div>
    );
}

Fichier : src/ui/components/ChatMessage.tsx (mise √† jour)
TypeScript

// ...

// Nouveau sous-composant pour le footer des sources
const SourcesFooter: React.FC<{ sources: any[] }> = ({ sources }) => (
    <div className="sources-footer">
        <strong>Sources consult√©es :</strong>
        <div className="sources-list">
            {sources.map(source => (
                <span key={source.id} className="source-badge" title={source.title}>
                    üìÑ {source.title.substring(0, 30)}...
                </span>
            ))}
        </div>
    </div>
);

// Dans le composant ChatMessage
const ChatMessage: React.FC<{ message: Message }> = ({ message }) => {
    // ...
    return (
        <div className={`message ${message.role}`}>
            <div className="message-content">{message.content}</div>
            
            {/* ... (actions comme "Voir la r√©flexion" et satisfaction) */}

            {/* NOUVEAU : Affichage du footer des sources */}
            {message.sources && message.sources.length > 0 && (
                <SourcesFooter sources={message.sources} />
            )}

            {showJournal && message.journal && <JournalCognitif journal={message.journal} />}
        </div>
    );
};

    Commentaire : Le JournalCognitif peut maintenant afficher une liste d√©taill√©e des affirmations v√©rifi√©es, avec un statut visuel clair (‚úÖ, üü°, ‚ö†Ô∏è, ‚ùå). Le ChatMessage affiche un footer simple et propre listant les documents consult√©s, comme nous l'avions d√©cid√© pour rester pragmatique.

Conclusion de la T√¢che

    Statut : ‚úÖ Termin√©.
    Livrables :
        Un SynthesizerAgent qui module sa r√©ponse en fonction de la fiabilit√© des faits.
        Un JournalCognitif qui offre une transparence totale sur le processus de v√©rification.
        Un ChatMessage qui affiche les sources utilis√©es, renfor√ßant la confiance de l'utilisateur.
