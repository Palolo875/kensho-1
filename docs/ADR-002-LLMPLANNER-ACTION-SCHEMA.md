# ADR-002: LLMPlanner Action Schema Contract

## Status
Accepted

## Date
2025-11-22

## Context

The LLMPlanner system was originally designed with prompts that instructed the LLM to generate plans using a `method` field to specify agent actions (e.g., `CalculatorAgent.calculate`). However, the TypeScript `PlanStep` interface in the codebase used an `action` field instead. This inconsistency caused validation failures, runtime errors, and unpredictable behavior when the LLMPlanner generated plans that didn't match the expected schema.

Additionally, the MainLLMAgent's prompt was originally passed via `args.prompt`, but the system architecture called for a dedicated `prompt` field at the plan step level to enable proper interpolation of results from previous steps (e.g., replacing `{{step1_result}}` with calculator outputs).

## Decision

We have standardized the LLMPlanner system to use the following contract:

### 1. Plan Step Schema
All plan steps MUST use:
- **`action`**: A string field identifying the agent action (e.g., `"calculate"`, `"generateResponse"`)
- **`agent`**: The agent name (e.g., `"CalculatorAgent"`, `"MainLLMAgent"`)
- **`args`**: An object containing tool arguments (empty `{}` for MainLLMAgent)
- **`prompt`** (optional): For MainLLMAgent steps, the text prompt to generate a response from

### 2. Prompt Updates
Both the primary planner prompt (`getPlannerPrompt`) and fallback prompt (`getFallbackPlannerPrompt`) have been updated to:
- Describe agents using "Action" terminology instead of "Method"
- Provide examples using the `action` field in JSON output
- Instruct the LLM to place MainLLMAgent prompts in the dedicated `prompt` field, not in `args`

### 3. Code Alignment
- **LLMPlanner.createFallbackPlan**: Updated to generate MainLLMAgent steps with empty `args: {}` and user query in the `prompt` field
- **TaskExecutor**: Enhanced to:
  - Use `step.prompt` as the primary source for MainLLMAgent prompts
  - Interpolate `{{stepN_result}}` placeholders in prompts with results from previous tool executions
  - Fall back to `originalQuery` only when `step.prompt` is undefined

### 4. Example Plan Structure

#### Simple Conversation (No Tools)
```json
{
  "thought": "This is a simple greeting, no tools needed.",
  "steps": [
    {
      "agent": "MainLLMAgent",
      "action": "generateResponse",
      "args": {},
      "prompt": "Hello, how are you?"
    }
  ]
}
```

#### Calculator Flow (Multi-Step)
```json
{
  "thought": "User wants to calculate 15 * 3, then get a natural response.",
  "steps": [
    {
      "agent": "CalculatorAgent",
      "action": "calculate",
      "args": { "expression": "15 * 3" }
    },
    {
      "agent": "MainLLMAgent",
      "action": "generateResponse",
      "args": {},
      "prompt": "The result of 15 * 3 is {{step1_result}}. Provide a friendly response."
    }
  ]
}
```

## Consequences

### Positive
- **Schema Consistency**: The entire system (prompts, code, types) now uses the same terminology and structure
- **Result Interpolation**: Multi-step plans can now properly pass tool outputs to the final LLM response
- **Predictable Validation**: Plans generated by the LLM will pass validation and execute correctly
- **Maintainability**: Future contributors have a clear contract to follow

### Negative
- **Migration Requirement**: Any cached plans or external documentation referring to `method` will need updates
- **Testing Burden**: Comprehensive integration tests are needed to prevent regressions

### Neutral
- **Documentation Debt**: Related docs (SPRINT3 guides, EXAMPLES.ts) should be updated to reflect the new schema

## Validation Required

Before considering this ADR complete, the following tests should be performed:

1. **Simple Chat**: Verify that a basic greeting generates a single-step MainLLMAgent plan with correct prompt field
2. **Calculator Flow**: Test that "What is 15 * 3?" generates a two-step plan and correctly interpolates the result
3. **Error Handling**: Confirm that division-by-zero errors trigger a fallback plan with proper prompt structure
4. **Fallback Plan**: Verify that when LLM planning fails, the fallback plan uses the correct schema

## References

- TypeScript interface: `src/agents/oie/types.ts` (PlanStep, Plan)
- Prompt definitions: `src/agents/oie/prompts.ts`
- Planner logic: `src/agents/oie/planner.ts`
- Executor logic: `src/agents/oie/executor.ts`
- UI visualization: `src/components/PlanView.tsx`

## Related ADRs

- ADR-001: (Future) Distributed Agent Communication Architecture
- ADR-003: (Future) WebGPU LLM Integration Strategy
