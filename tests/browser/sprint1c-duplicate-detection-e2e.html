<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <title>Kensho - Sprint 1C - Test E2E de DÃ©tection de Doublons</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 40px auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
        }

        h1 {
            color: white;
            text-align: center;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        p {
            color: #f0f0f0;
            text-align: center;
            font-size: 1.1rem;
        }

        button {
            display: block;
            margin: 20px auto;
            padding: 15px 30px;
            font-size: 1.2rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        #results {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            min-height: 400px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.6;
            white-space: pre-wrap;
            overflow-x: auto;
        }

        .log-info {
            color: #2563eb;
        }

        .log-pass {
            color: #16a34a;
            font-weight: bold;
        }

        .log-fail {
            color: #dc2626;
            font-weight: bold;
        }

        .log-warn {
            color: #ea580c;
        }

        .log-summary {
            color: #7c3aed;
            font-weight: bold;
            font-size: 1.1rem;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 2px solid #e5e7eb;
        }
    </style>
</head>

<body>
    <h1>ğŸ” Sprint 1C - Test E2E de DÃ©tection de Doublons</h1>
    <p>Ce test valide que le MessageBus ignore les requÃªtes dupliquÃ©es et retourne la rÃ©ponse mise en cache.</p>
    <button id="run-tests">ğŸš€ Lancer le Test</button>
    <h2 style="color: white; text-align: center;">RÃ©sultats :</h2>
    <pre id="results"></pre>

    <script type="module">
        const resultsEl = document.getElementById('results');

        const log = (message, status = 'info') => {
            const timestamp = new Date().toLocaleTimeString();
            const className = `log-${status}`;
            const line = document.createElement('span');
            line.className = className;
            line.textContent = `[${timestamp}] ${message}\n`;
            resultsEl.appendChild(line);
            resultsEl.scrollTop = resultsEl.scrollHeight;
        };

        const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        document.getElementById('run-tests').addEventListener('click', async () => {
            resultsEl.innerHTML = '';
            log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'summary');
            log('    DÃ‰MARRAGE DU TEST DE DÃ‰TECTION DE DOUBLONS', 'summary');
            log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'summary');
            log('');

            const { MessageBus } = await import('/src/core/communication/MessageBus.ts');
            let busA = null;
            let busB = null;
            let testPassed = true;

            try {
                // --- Ã‰tape 1: Setup ---
                log('[Ã‰tape 1] Configuration des MessageBus...', 'info');
                log('  â†’ CrÃ©ation de AgentA et AgentB', 'info');
                busA = new MessageBus('AgentA');
                busB = new MessageBus('AgentB');

                // Le handler de l'AgentB va incrÃ©menter un compteur pour tracer ses exÃ©cutions
                let executionCount = 0;
                busB.setRequestHandler(async (payload) => {
                    executionCount++;
                    log(`  âš™ï¸  Handler AgentB exÃ©cutÃ© (compteur: ${executionCount})`, 'info');
                    await sleep(100); // Simuler un travail
                    return { result: `Response for ${payload.data}`, executionNumber: executionCount };
                });
                log('  âœ… Handler configurÃ© avec compteur d\'exÃ©cution', 'pass');
                log('');

                // --- Ã‰tape 2: Envoyer une requÃªte dupliquÃ©e ---
                log('[Ã‰tape 2] Test de duplication de requÃªte...', 'info');
                log('  â†’ Construction d\'un message avec ID fixe', 'info');

                const traceId = `trace-${crypto.randomUUID()}`;
                const messageId = `msg-duplicate-test-${crypto.randomUUID()}`;
                const payload = { data: 'test-duplicate' };

                const message = {
                    messageId,
                    traceId,
                    payload,
                    type: 'request',
                    sourceWorker: 'AgentA',
                    targetWorker: 'AgentB',
                };

                log(`  â†’ MessageID: ${messageId.substring(0, 30)}...`, 'info');
                log('  â†’ Envoi du message (1Ã¨re fois)', 'info');
                busA.resendMessage(message);

                await sleep(200); // Attendre que la 1Ã¨re requÃªte soit traitÃ©e

                log('  â†’ Envoi du MÃŠME message (2Ã¨me fois - DOUBLON)', 'warn');
                busA.resendMessage(message);

                await sleep(200); // Attendre un peu plus

                log('');

                // --- Ã‰tape 3: VÃ©rification ---
                log('[Ã‰tape 3] VÃ©rification des rÃ©sultats...', 'info');
                log(`  â†’ Nombre d'exÃ©cutions du handler: ${executionCount}`, 'info');

                if (executionCount === 1) {
                    log('  âœ… SUCCÃˆS: Le handler n\'a Ã©tÃ© exÃ©cutÃ© qu\'UNE SEULE FOIS !', 'pass');
                    log('  âœ… La requÃªte dupliquÃ©e a Ã©tÃ© ignorÃ©e comme prÃ©vu', 'pass');
                } else {
                    throw new Error(`Le handler a Ã©tÃ© exÃ©cutÃ© ${executionCount} fois au lieu de 1. Le cache de dÃ©tection de doublons ne fonctionne pas correctement.`);
                }

                log('');

                // --- Ã‰tape 4: Test supplÃ©mentaire - VÃ©rifier que diffÃ©rents messages sont bien traitÃ©s ---
                log('[Ã‰tape 4] Test complÃ©mentaire: messages diffÃ©rents...', 'info');
                const message2 = {
                    messageId: `msg-different-${crypto.randomUUID()}`,
                    traceId: `trace-${crypto.randomUUID()}`,
                    payload: { data: 'different-message' },
                    type: 'request',
                    sourceWorker: 'AgentA',
                    targetWorker: 'AgentB',
                };

                log('  â†’ Envoi d\'un message avec ID diffÃ©rent', 'info');
                busA.resendMessage(message2);
                await sleep(200);

                if (executionCount === 2) {
                    log('  âœ… SUCCÃˆS: Le nouveau message a bien Ã©tÃ© traitÃ© !', 'pass');
                    log('  âœ… Le cache ne bloque pas les messages lÃ©gitimes', 'pass');
                } else {
                    throw new Error(`Attendu 2 exÃ©cutions mais obtenu ${executionCount}`);
                }

            } catch (error) {
                log('', 'fail');
                log(`âŒ ERREUR CRITIQUE: ${error.message}`, 'fail');
                log('', 'fail');
                testPassed = false;
            } finally {
                if (busA) busA.dispose();
                if (busB) busB.dispose();

                log('');
                log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'summary');
                if (testPassed) {
                    log('    ğŸ‰ TEST RÃ‰USSI - DÃ‰TECTION DE DOUBLONS VALIDÃ‰E !', 'pass');
                    log('', 'pass');
                    log('    âœ… Les requÃªtes dupliquÃ©es sont dÃ©tectÃ©es', 'pass');
                    log('    âœ… La rÃ©ponse mise en cache est retournÃ©e', 'pass');
                    log('    âœ… La logique mÃ©tier n\'est exÃ©cutÃ©e qu\'une seule fois', 'pass');
                    log('    âœ… Les messages diffÃ©rents sont traitÃ©s normalement', 'pass');
                } else {
                    log('    âŒ TEST Ã‰CHOUÃ‰ - DES PROBLÃˆMES ONT Ã‰TÃ‰ DÃ‰TECTÃ‰S', 'fail');
                }
                log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'summary');
            }
        });
    </script>
</body>

</html>