<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test de FaisabilitÃ© web-llm</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        #console {
            background-color: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            min-height: 400px;
            overflow-y: auto;
        }
        .info { color: #4ec9b0; }
        .warn { color: #dcdcaa; }
        .error { color: #f48771; }
        .success { color: #4fc1ff; }
        h1 {
            color: #333;
            text-align: center;
        }
    </style>
</head>
<body>
    <h1>ðŸ§ª Test de FaisabilitÃ© web-llm</h1>
    <div id="console"></div>

    <script type="module">
        import * as webllm from "@mlc-ai/web-llm";

        const consoleDiv = document.getElementById('console');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const line = document.createElement('div');
            line.className = type;
            line.textContent = `[${timestamp}] ${message}`;
            consoleDiv.appendChild(line);
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }

        // --- Configuration ---
        const MODEL_ID = "TinyLlama-1.1B-Chat-v1.0-q4f32_1-MLC";

        async function runWebLLMTest() {
            log("--- DÃ©marrage du Test de FaisabilitÃ© web-llm ---", 'success');
            log("");

            try {
                // VÃ©rifier le support WebGPU
                if (!navigator.gpu) {
                    throw new Error("âŒ WebGPU n'est pas supportÃ© par ce navigateur. Veuillez utiliser Chrome/Edge 113+ ou Firefox Nightly.");
                }
                log("âœ“ WebGPU est disponible", 'success');
                log("");

                // --- Ã‰tape 1: CrÃ©ation du Moteur ---
                log(`[1/3] CrÃ©ation du moteur MLC avec le modÃ¨le : ${MODEL_ID}`, 'info');
                const startTime = performance.now();
                
                const engine = await webllm.CreateMLCEngine(
                    MODEL_ID,
                    { 
                        initProgressCallback: (progress) => {
                            log(`  -> Progress: ${progress.text}`, 'info');
                        }
                    }
                );
                
                const loadDuration = ((performance.now() - startTime) / 1000).toFixed(2);
                log(`[PASS] Moteur chargÃ© et initialisÃ© en ${loadDuration} secondes.`, 'success');
                log("");

                // --- Ã‰tape 2: ExÃ©cution d'une InfÃ©rence Simple ---
                log("[2/3] ExÃ©cution d'une infÃ©rence de chat simple...", 'info');
                const prompt = "Explique la relativitÃ© gÃ©nÃ©rale en une seule phrase simple.";
                log(`  > Prompt: "${prompt}"`, 'info');

                const inferenceStartTime = performance.now();
                const response = await engine.chat.completions.create({
                    messages: [{ role: "user", content: prompt }],
                });
                const inferenceDuration = ((performance.now() - inferenceStartTime) / 1000).toFixed(2);
                
                log(`[PASS] InfÃ©rence terminÃ©e en ${inferenceDuration} secondes.`, 'success');
                log("");
                
                // --- Ã‰tape 3: VÃ©rification de la RÃ©ponse ---
                log("[3/3] VÃ©rification de la rÃ©ponse...", 'info');
                const reply = response.choices[0]?.message?.content;

                if (reply && reply.trim().length > 0) {
                    log(`  < RÃ©ponse reÃ§ue: "${reply.trim()}"`, 'info');
                    log("");
                    log("[CONCLUSION] âœ… Le test de faisabilitÃ© web-llm est un SUCCÃˆS !", 'success');
                } else {
                    throw new Error("La rÃ©ponse du modÃ¨le est vide ou invalide.");
                }

            } catch (error) {
                log("");
                log(`[CONCLUSION] âŒ Le test de faisabilitÃ© web-llm a Ã‰CHOUÃ‰.`, 'error');
                log(`Erreur: ${error.message}`, 'error');
                if (error.stack) {
                    log(`Stack: ${error.stack}`, 'error');
                }
            }
        }

        // Lancer le test au chargement de la page
        window.addEventListener('load', runWebLLMTest);
    </script>
</body>
</html>
