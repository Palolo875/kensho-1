<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test de Faisabilit√© web-llm</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        #console {
            background-color: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            min-height: 400px;
            overflow-y: auto;
        }
        .info { color: #4ec9b0; }
        .warn { color: #dcdcaa; }
        .error { color: #f48771; }
        .success { color: #4fc1ff; }
        h1 {
            color: #333;
            text-align: center;
        }
    </style>
</head>
<body>
    <h1>üß™ Test de Faisabilit√© web-llm</h1>
    <div id="console"></div>

    <script type="module">
        import * as webllm from "@mlc-ai/web-llm";

        const consoleDiv = document.getElementById('console');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const line = document.createElement('div');
            line.className = type;
            line.textContent = `[${timestamp}] ${message}`;
            consoleDiv.appendChild(line);
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }

        // --- Configuration ---
        const MODEL_ID = "TinyLlama-1.1B-Chat-v1.0-q4f32_1-MLC";

        async function runWebLLMTest() {
            log("--- D√©marrage du Test de Faisabilit√© web-llm ---", 'success');
            log("");

            // Capturer l'√©tat initial de la m√©moire si disponible
            let initialMemory = null;
            try {
                if (performance.memory) {
                    initialMemory = {
                        usedJSHeapSize: performance.memory.usedJSHeapSize,
                        totalJSHeapSize: performance.memory.totalJSHeapSize,
                        jsHeapSizeLimit: performance.memory.jsHeapSizeLimit
                    };
                    log(`[M√âMOIRE INITIALE] Heap utilis√©: ${(initialMemory.usedJSHeapSize / 1024 / 1024).toFixed(2)} MB`, 'info');
                }
            } catch (e) {
                // performance.memory n'est pas disponible dans ce navigateur
                log(`[INFO] Monitoring de m√©moire non disponible dans ce navigateur`, 'info');
            }
            log("");

            try {
                // V√©rifier le support WebGPU avec gestion d'erreurs d√©taill√©e
                if (!navigator.gpu) {
                    throw new Error("‚ùå WebGPU n'est pas support√© par ce navigateur. Veuillez utiliser Chrome/Edge 113+ ou Firefox Nightly.");
                }
                
                // Tester l'acc√®s √† l'adaptateur GPU
                try {
                    const adapter = await navigator.gpu.requestAdapter();
                    if (!adapter) {
                        throw new Error("‚ùå Aucun adaptateur GPU n'a pu √™tre obtenu. Votre mat√©riel pourrait ne pas supporter WebGPU.");
                    }
                    log("‚úì WebGPU est disponible et un adaptateur GPU a √©t√© trouv√©", 'success');
                    
                    // Logger les informations de l'adaptateur
                    const adapterInfo = await adapter.requestAdapterInfo();
                    log(`  -> GPU: ${adapterInfo.description || 'Inconnu'}`, 'info');
                } catch (gpuError) {
                    throw new Error(`‚ùå Erreur lors de l'initialisation WebGPU: ${gpuError.message}. V√©rifiez que votre navigateur et votre mat√©riel supportent WebGPU.`);
                }
                log("");

                // --- √âtape 1: Cr√©ation du Moteur ---
                log(`[1/4] Cr√©ation du moteur MLC avec le mod√®le : ${MODEL_ID}`, 'info');
                const startTime = performance.now();
                
                const engine = await webllm.CreateMLCEngine(
                    MODEL_ID,
                    { 
                        initProgressCallback: (progress) => {
                            log(`  -> Progress: ${progress.text}`, 'info');
                        }
                    }
                );
                
                const loadDuration = ((performance.now() - startTime) / 1000).toFixed(2);
                log(`[PASS] Moteur charg√© et initialis√© en ${loadDuration} secondes.`, 'success');
                
                // Mesurer la m√©moire apr√®s chargement si disponible
                if (initialMemory) {
                    try {
                        const memoryAfterLoad = performance.memory.usedJSHeapSize;
                        const memoryIncrease = (memoryAfterLoad - initialMemory.usedJSHeapSize) / 1024 / 1024;
                        log(`  -> M√©moire utilis√©e apr√®s chargement: +${memoryIncrease.toFixed(2)} MB`, 'info');
                    } catch (e) {
                        // Ignore si performance.memory n'est plus disponible
                    }
                }
                log("");

                // --- √âtape 2: Ex√©cution d'une Inf√©rence Simple ---
                log("[2/4] Ex√©cution d'une inf√©rence de chat simple...", 'info');
                const prompt = "Explique la relativit√© g√©n√©rale en une seule phrase simple.";
                log(`  > Prompt: "${prompt}"`, 'info');

                const inferenceStartTime = performance.now();
                const response = await engine.chat.completions.create({
                    messages: [{ role: "user", content: prompt }],
                });
                const inferenceDuration = ((performance.now() - inferenceStartTime) / 1000).toFixed(2);
                
                log(`[PASS] Inf√©rence termin√©e en ${inferenceDuration} secondes.`, 'success');
                
                // Mesurer la m√©moire apr√®s inf√©rence si disponible
                if (initialMemory) {
                    try {
                        const memoryAfterInference = performance.memory.usedJSHeapSize;
                        const currentUsage = (memoryAfterInference / 1024 / 1024).toFixed(2);
                        log(`  -> M√©moire totale utilis√©e: ${currentUsage} MB`, 'info');
                    } catch (e) {
                        // Ignore si performance.memory n'est plus disponible
                    }
                }
                log("");
                
                // --- √âtape 3: V√©rification de la R√©ponse ---
                log("[3/4] V√©rification de la r√©ponse...", 'info');
                const reply = response.choices[0]?.message?.content;

                if (!reply || reply.trim().length === 0) {
                    throw new Error("La r√©ponse du mod√®le est vide ou invalide.");
                }
                
                log(`  < R√©ponse re√ßue: "${reply.trim()}"`, 'info');
                log("");
                
                // --- √âtape 4: Validation de la Qualit√© de la R√©ponse ---
                log("[4/4] Validation de la qualit√© de la r√©ponse...", 'info');
                
                // V√©rifier la pr√©sence de mots-cl√©s pertinents pour la relativit√© g√©n√©rale
                const keywords = ['gravit', 'espace', 'temps', 'masse', 'courb', 'einstein', 'relativi'];
                const lowerReply = reply.toLowerCase();
                const foundKeywords = keywords.filter(kw => lowerReply.includes(kw));
                
                if (foundKeywords.length > 0) {
                    log(`  ‚úì Mots-cl√©s pertinents trouv√©s: ${foundKeywords.join(', ')}`, 'success');
                    log(`  ‚úì La r√©ponse semble coh√©rente avec le sujet demand√©`, 'success');
                } else {
                    log(`  ‚ö† Aucun mot-cl√© pertinent trouv√©, mais la r√©ponse est g√©n√©r√©e`, 'warn');
                }
                
                // V√©rifier la longueur de la r√©ponse (une phrase devrait √™tre entre 10 et 200 caract√®res environ)
                if (reply.trim().length > 10 && reply.trim().length < 500) {
                    log(`  ‚úì Longueur de r√©ponse appropri√©e: ${reply.trim().length} caract√®res`, 'success');
                } else if (reply.trim().length < 10) {
                    log(`  ‚ö† R√©ponse tr√®s courte: ${reply.trim().length} caract√®res`, 'warn');
                } else {
                    log(`  ‚ö† R√©ponse longue: ${reply.trim().length} caract√®res`, 'warn');
                }
                log("");
                
                log("[CONCLUSION] ‚úÖ Le test de faisabilit√© web-llm est un SUCC√àS !", 'success');
                log("Le syst√®me peut g√©rer l'inf√©rence on-device sans backend.", 'success');

            } catch (error) {
                log("");
                log(`[CONCLUSION] ‚ùå Le test de faisabilit√© web-llm a √âCHOU√â.`, 'error');
                log(`Erreur: ${error.message}`, 'error');
                
                // Classifier les types d'erreurs pour aider au diagnostic
                if (error.message.includes('WebGPU')) {
                    log("Type d'erreur: Support WebGPU", 'error');
                    log("Solution: Utilisez Chrome/Edge 113+ ou activez WebGPU dans les flags du navigateur", 'error');
                } else if (error.message.includes('GPU') || error.message.includes('adapter')) {
                    log("Type d'erreur: Mat√©riel GPU", 'error');
                    log("Solution: V√©rifiez que votre carte graphique supporte WebGPU", 'error');
                } else if (error.message.includes('r√©seau') || error.message.includes('fetch')) {
                    log("Type d'erreur: R√©seau/Chargement du mod√®le", 'error');
                    log("Solution: V√©rifiez votre connexion internet", 'error');
                } else {
                    log("Type d'erreur: Autre", 'error');
                }
                
                if (error.stack) {
                    log(`Stack trace: ${error.stack}`, 'error');
                }
            }
        }

        // Lancer le test au chargement de la page
        window.addEventListener('load', runWebLLMTest);
    </script>
</body>
</html>
